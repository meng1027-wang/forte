from pyscf import gto, scf, mcscf, fci, symm
from pyscf.tools import cubegen
import numpy as np
import re
import sys
sys.path.append("../../")
from create_psi4_cas_hamiltonian import *

mol = gto.Mole()
mol.atom='''
             Y 0 0 0
                 '''
mol.symmetry='d2h'
mol.spin=1
mol.charge=0
mol.verbose=6

mol.basis = {'Y': '''
Y    S
4002065.2406000              0.49151393868E-03      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
 478108.7418200              0.17554140306E-02      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
  93223.2665730              0.54722795924E-02      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
  23771.2439000              0.16378081594E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
   7163.4265166              0.47519075193E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
   2419.9399921              0.12870204354          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    884.97525392             0.28741671173          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    861.72721061             0.0000000             -0.35832760170E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    344.58194710             0.43288206775          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    254.76692604             0.0000000             -0.16792095168          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    134.94650328             0.26707296557          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     45.375824656            0.0000000              0.70690358985          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     28.645958946            0.0000000              0.0000000             -0.33288913247          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     20.761525998            0.0000000              0.96342322722          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      6.3424726632           0.0000000              0.0000000              0.45752735730          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      3.4126393704           0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000              0.0000000              0.0000000
      0.92767431638          0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000              0.0000000
      0.42902831724          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000
      0.66443160128E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000
      0.28391808014E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000
Y    P
  69110.8087590              0.66022562861E-04      0.23250214103E-03      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
  11261.6012760              0.30121773027E-03      0.14371622168E-02      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
   2896.6460454              0.12615876709E-02      0.75727251547E-02      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    943.78536428             0.50556202483E-02      0.34595269283E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    353.27173286             0.17639230664E-01      0.12927449905          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    145.60258883             0.46969704138E-01      0.35713754971          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    142.87253008             0.0000000              0.0000000              0.0000000              0.0000000              0.40083010018E-02      0.0000000              0.0000000              0.0000000              0.0000000
     64.411128162            0.81780031565E-01      0.64144067673          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     57.744152672            0.0000000              0.0000000              0.0000000              0.0000000              0.15370215421E-01      0.0000000              0.0000000              0.0000000              0.0000000
     29.857524917            0.77081194095E-01      0.62512495013          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     13.640107011            0.0000000              0.0000000              0.0000000              0.0000000             -0.14415300090          0.0000000              0.0000000              0.0000000              0.0000000
     13.481203011            0.0000000              0.21235042153          1.0000000000           0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      6.1816267211           0.0000000              0.0000000              0.0000000              0.0000000             -0.37876286486          0.0000000              0.0000000              0.0000000              0.0000000
      5.3562484786           0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      4.7391667000           0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.51973952806E-02      0.0000000              0.0000000              0.0000000
      2.6967672556           0.0000000              0.0000000              0.0000000              0.0000000             -0.23366181430          0.0000000              0.0000000              0.0000000              0.0000000
      1.4962428529           0.0000000              0.0000000              0.0000000              0.0000000              0.0000000             -0.35995915009E-01      0.0000000              0.0000000              0.0000000
      0.83459303078          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000             -0.12706449933          0.0000000              0.0000000              0.0000000
      0.33297224187          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000
      0.95134926249E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000
      0.27000000000E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000
Y    D
    364.78557814             0.41721255364E-02      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
    108.75276057             0.31219034646E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     41.492261666            0.12416322041          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
     17.740929226            0.29585157517          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      8.0885862445           0.41124610102          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      7.6451996965           0.0000000              1.0000000000           0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      4.0514553161           0.0000000              0.0000000              0.51827634974E-01      0.0000000              0.0000000              0.0000000              0.0000000
      3.8771983669           0.31203674651          0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000
      1.8928692764           0.0000000              0.0000000              0.26849331764          0.0000000              0.0000000              0.0000000              0.0000000
      0.78749899485          0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000              0.0000000
      0.28269654950          0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000              0.0000000
      0.89804520347E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000           0.0000000
      0.28500000000E-01      0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              0.0000000              1.0000000000
Y    F
      0.2651500              1.0000000
'''}
mol.build()
mf = scf.RHF(mol).sfx2c1e().run(conv_tol=1e-10)


ncaselec = 3
ncore = (mol.nelectron - ncaselec) // 2
ncas = 9

mo_coeff_sorted = mf.mo_coeff
mo_energy_sorted = mf.mo_energy
orbs_irrep = symm.label_orb_symm(mol, mol.irrep_name, mol.symm_orb, mf.mo_coeff)
print(orbs_irrep)
for i in range(mol.nao):
        print(f'MO {i+1}: Energy = {mo_energy_sorted[i]}')
for i in range(18, 30):
    cubegen.orbital(mol, f'mo_{i+1},cube', mf.mo_coeff[:, i])


weights = np.ones(32)/32
solver1 = fci.direct_spin1_symm.FCI(mol)
solver1 = fci.addons.fix_spin(solver1, shift=0.5, ss=0.75)
solver1.wfnsym= 'Ag'
solver1.spin = 1
solver1.nroots = 3

solver2 = fci.direct_spin1_symm.FCI(mol)
solver2 = fci.addons.fix_spin(solver2, shift=0.5, ss=0.75)
solver2.wfnsym= 'B1g'
solver2.spin = 1
solver2.nroots = 4

solver3 = fci.direct_spin1_symm.FCI(mol)
solver3 = fci.addons.fix_spin(solver3, shift=0.5, ss=0.75)
solver3.wfnsym= 'B2g'
solver3.spin = 1
solver3.nroots = 4

solver4 = fci.direct_spin1_symm.FCI(mol)
solver4 = fci.addons.fix_spin(solver4, shift=0.5, ss=0.75)
solver4.wfnsym= 'B3g'
solver4.spin = 1
solver4.nroots = 4

solver5 = fci.direct_spin1_symm.FCI(mol)
solver5 = fci.addons.fix_spin(solver5, shift=0.5, ss=3.75)
solver5.wfnsym= 'Ag'
solver5.spin = 3
solver5.nroots = 2

solver6 = fci.direct_spin1_symm.FCI(mol)
solver6 = fci.addons.fix_spin(solver6, shift=0.5, ss=3.75)
solver6.wfnsym= 'B1g'
solver6.spin = 3
solver6.nroots = 5

solver7 = fci.direct_spin1_symm.FCI(mol)
solver7 = fci.addons.fix_spin(solver7, shift=0.5, ss=3.75)
solver7.wfnsym= 'B2g'
solver7.spin = 3
solver7.nroots = 5

solver8 = fci.direct_spin1_symm.FCI(mol)
solver8 = fci.addons.fix_spin(solver8, shift=0.5, ss=3.75)
solver8.wfnsym= 'B3g'
solver8.spin = 3
solver8.nroots = 5



mycas = mcscf.CASSCF(mf, ncas, ncaselec)
mycas.conv_tol = 1e-8
mycas.conv_tol_grad = 1e-7
mycas.max_cycle_macro = 100
mcscf.state_average_mix_(mycas, [solver1, solver2, solver3, solver4, solver5, solver6, solver7, solver8], weights)
## Note sort_mo by default take the 1-based orbital indices.
#mo = mycas.sort_mo([3,6,7,8,9,12])
mycas.kernel()
rdm1 = mycas.make_rdm1()
np.save('dmao.npy', rdm1)
coeff = mycas.mo_coeff
np.save('mo_coeff.npy', coeff)

f_pq_pyscf = get_soc_fpq_pyscf(ncas, ncore, ncaselec, mol, mf, ca=coeff, ao_rdm1=rdm1, amfi=True)
np.save('f_pq_pyscf.npy', f_pq_pyscf)


